<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      /* common */
      .field {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;

        input {
          padding: 0.5rem 1rem;
        }
      }
      button {
        width: 150px;
        padding: 0.5rem 1rem;
        font-size: 1rem;
        line-height: 1rem;
      }
      /* form */
      body {
        background-color: #f4f4f4;
      }
      .form-container {
        display: flex;
        flex-direction: column;
        background-color: #fafafa;
        padding: 1rem;
      }
      form {
        display: flex;
        flex-direction: row;
        align-items: flex-end;
        gap: 1.5rem;
        flex-wrap: wrap;
        padding: 1rem;
        box-shadow: 0 0 5px 0 #ebebeb;
        border: 1px solid #aaa;
        border-radius: 0.5rem;
      }
      /* table */
      #table-container {
        display: flex;
        flex-direction: column;
        background-color: #fafafa;
        padding: 1rem;
      }
      table {
        border: 1px solid #555;
        width: 100%;
        border-radius: 0.5rem;
      }

      td {
        padding: 0.5rem;
        border: 1px solid red;
      }
    </style>
  </head>
  <body>
    <main>
      <!-- form -->
      <div class="form-container">
        <h2>Chickens form</h2>
        <form onsubmit="onAddChickenSubmitted(event)">
          <!-- ID -->
          <div class="field">
            <label for="id">ID</label>
            <input required type="text" name="id" id="id" />
          </div>
          <!-- name -->
          <div class="field">
            <label for="name">Name</label>
            <input required type="text" name="name" id="name" />
          </div>
          <!-- currentPrice -->
          <div class="field">
            <label for="currentPrice">Current Price</label>
            <input
              required
              type="number"
              name="currentPrice"
              id="currentPrice"
            />
          </div>
          <!-- Last Price -->
          <div class="field">
            <label for="lastPrice">Last Price</label>
            <input required type="number" name="lastPrice" id="lastPrice" />
          </div>

          <button>Add</button>
        </form>
      </div>
      <!-- table -->
      <div id="table-container">
        <h2>Chickens Table</h2>
        <div class="filter-container">
          <form onsubmit="handleSubmitFilter(event)">
            <!-- Last Price -->
            <div class="field">
              <label for="min-price">Min Price</label>
              <input type="number" name="min-price" id="min-price" />
            </div>
            <!-- Last Price -->
            <div class="field">
              <label for="max-price">Max Price</label>
              <input type="number" name="max-price" id="max-price" />
            </div>
            <!-- btn -->
            <button>Search</button>
          </form>
        </div>
        <!-- table -->
        <table id="chickens-table">
          <thead>
            <tr>
              <td>id</td>
              <td>name</td>
              <td>current price</td>
              <td>last price</td>
            </tr>
          </thead>
          <tbody id="chickens-table-body"></tbody>
        </table>
      </div>
      <!-- queries -->
      <div>
        <button onclick="handleDeleteCheap()">Delete cheap chickens</button>
      </div>
      <!--  -->
    </main>
  </body>
  <script>
    const openRequest = indexedDB.open("chickens-db", 1);

    openRequest.onupgradeneeded = function (event) {
      let db = openRequest.result;

      if (!db.objectStoreNames.contains("chickens")) {
        const chiksStore = db.createObjectStore("chickens", { keyPath: "id" });
        const trans = chiksStore.transaction;

        trans
          .objectStore("chickens")
          .createIndex("current_price_idx", "currentPrice");
      } else {
        const transaction = event.target.transaction;
        const store = transaction.objectStore("chickens");
        if (!store.indexNames.contains("current_price_idx")) {
          store.createIndex("current_price_idx", "currentPrice");
        }
      }
    };

    openRequest.onerror = function () {
      console.error("Error", openRequest.error);
    };

    openRequest.onsuccess = function () {
      let db = openRequest.result;

      db.onversionchange = function () {
        db.close();
        alert("Database is outdated, please reload the page.");
      };

      init();
    };

    openRequest.onblocked = function () {
      // this event shouldn't trigger if we handle onversionchange correctly
      // it means that there's another open connection to the same database
      // and it wasn't closed after db.onversionchange triggered for it
    };

    const addChicken = (chicken) => {
      const db = openRequest.result;
      const trans = db.transaction("chickens", "readwrite");

      if (trans) {
        const chickens = trans.objectStore("chickens");
        let request = chickens.add(chicken);
        request.onsuccess = function () {
          console.log("chicken added to the store", request.result);
        };
        request.onerror = function () {
          console.log("Error", request.error);
        };
      }
    };

    const deleteCheapChickens = (priceLimit = 100) => {
      return new Promise((res, rej) => {
        const db = openRequest.result;
        const tx = db.transaction("chickens", "readwrite");
        const store = tx.objectStore("chickens");
        const index = store.index("current_price_idx");

        const range = IDBKeyRange.upperBound(priceLimit);

        const cursorReq = index.openCursor(range);
        let deletedCount = 0;

        cursorReq.onsuccess = (e) => {
          const cursor = e.target.result;
          if (cursor) {
            cursor.delete();
            deletedCount++;
            cursor.continue();
          } else {
            res(deletedCount);
          }
        };

        cursorReq.onerror = () => rej(cursorReq.error);
      });
    };

    const handleDeleteCheap = async () => {
      const deleted = await deleteCheapChickens(12);
      alert(`Deleted ${deleted} chickens with price <= 12`);

      const refreshed = await getAllChicks();
      const tbody = document.getElementById("chickens-table-body");
      tbody.innerHTML = ""; // خالی کردن جدول
      addToTable(refreshed);
    };

    const addToTable = (chik) => {
      if (Array.isArray(chik)) {
        const trblist = chik.map((ch) => {
          const tr = `
            <td> ${ch.id} </td>
            <td> ${ch?.name ?? "-"} </td>
            <td> ${ch["currentPrice"]} </td>
            <td> ${ch["lastPrice"]} </td>
         `;
          const trb = document.createElement("tr");
          trb.innerHTML = tr;

          return trb;
        });
        const tbody = document.getElementById("chickens-table-body");
        tbody.append(...trblist);
      } else {
        const tr = `
          <td> ${chik.id} </td>
          <td> ${chik.name} </td>
          <td> ${chik["currentPrice"]} </td>
          <td> ${chik["lastPrice"]} </td>
      `;

        const trb = document.createElement("tr");
        trb.innerHTML = tr;

        const tbody = document.getElementById("chickens-table-body");
        tbody.appendChild(trb);
      }
    };

    const getAllChicks = () =>
      new Promise((res, rej) => {
        const db = openRequest.result;
        const trans = db.transaction("chickens");
        const chiksStore = trans.objectStore("chickens");

        const getAllChiksReq = chiksStore.getAll();
        getAllChiksReq.onsuccess = (e) => {
          const chiks = e.target.result;
          res(chiks);
        };
      });

    const getChicksByPrice = ({ minPrice, maxPrice }) => {
      return new Promise((res, rej) => {
        const db = openRequest.result;
        const trans = db.transaction("chickens");
        const chiksStore1 = trans.objectStore("chickens");
        const priceIndex = chiksStore1.index("current_price_idx");

        let range = undefined;
        if (minPrice !== undefined && maxPrice === undefined) {
          range = IDBKeyRange.upperBound(minPrice);
        } else if (minPrice === undefined && maxPrice !== undefined) {
          range = IDBKeyRange.lowerBound(maxPrice);
        } else if (minPrice !== undefined && maxPrice !== undefined) {
          range = IDBKeyRange.bound(minPrice, maxPrice);
        } else {
          return rej("at least one of min or max most be defined .");
        }

        const req = priceIndex.getAll(range);
        req.onsuccess = (e) => {
          console.log(e);

          res(e.target.result);
        };
        req.onerror = (e) => {
          rej("funck");
        };
      });
    };

    const onAddChickenSubmitted = (e) => {
      e.preventDefault();
      const newRecord = {
        id: e.srcElement[0].value,
        name: e.srcElement[1].value,
        currentPrice: Number(e.srcElement[2].value),
        lastPrice: Number(e.srcElement[3].value),
      };
      addChicken(newRecord);
      addToTable(newRecord);
    };

    // init
    const init = async () => {
      const chiks = await getAllChicks();
      addToTable(chiks);
    };
  </script>
  <script>
    const handleSubmitFilter = (e) => {
      e.preventDefault();

      const inputElemnts = e.target.elements;
      const inputValues = {};

      if (inputElemnts["max-price"].value.trim() !== "")
        inputValues["max-price"] = Number(inputElemnts["max-price"].value);

      if (inputElemnts["min-price"].value.trim() !== "")
        inputValues["min-price"] = Number(inputElemnts["min-price"].value);

      if (Object.keys(inputValues).length !== 0) {
        console.log(inputValues);

        getChicksByPrice({
          maxPrice: inputValues["max-price"],
          minPrice: inputValues["min-price"],
        }).then((res) => {
          console.log(res);
        });
      }
    };
  </script>
</html>
